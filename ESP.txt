return function(state)
    local Players = game:GetService("Players")
    local RunService = game:GetService("RunService")
    local localPlayer = Players.LocalPlayer

    if not getgenv().ESP_DATA then
        getgenv().ESP_DATA = {
            loop = nil,
            items = {},
            connections = {}
        }
    end

    local ESP = getgenv().ESP_DATA

    local function clearESP()
        if ESP.loop then
            ESP.loop:Disconnect()
            ESP.loop = nil
        end

        for _, obj in ipairs(ESP.items) do
            if obj and obj.Parent then obj:Destroy() end
        end
        ESP.items = {}

        for _, conn in ipairs(ESP.connections) do
            pcall(function() conn:Disconnect() end)
        end
        ESP.connections = {}
    end

    if not state then
        clearESP()
        print("❌ ESP desactivado")
        return
    end

    local function applyESPToCharacter(player, character)
        if not character or player == localPlayer then return end

        local hrp = character:FindFirstChild("HumanoidRootPart")
        local head = character:FindFirstChild("Head") or hrp
        if not hrp or not head then return end

        -- Highlight gris
        if not character:FindFirstChild("ESP_Highlight") then
            local highlight = Instance.new("Highlight")
            highlight.Name = "ESP_Highlight"
            highlight.Adornee = character
            highlight.FillColor = Color3.fromRGB(160, 160, 160)
            highlight.FillTransparency = 0.5
            highlight.OutlineColor = Color3.fromRGB(255, 255, 255)
            highlight.OutlineTransparency = 0
            highlight.Parent = character
            table.insert(ESP.items, highlight)
        end

        -- Mostrar nombre si está cerca
        local distance = (hrp.Position - localPlayer.Character.HumanoidRootPart.Position).Magnitude
        local existing = character:FindFirstChild("ESP_NameTag")

        if distance < 600 and not existing then
            local b = Instance.new("BillboardGui")
            b.Name = "ESP_NameTag"
            b.Adornee = head
            b.Size = UDim2.new(0, 100, 0, 40)
            b.StudsOffset = Vector3.new(0, 5, 0)
            b.AlwaysOnTop = true
            b.LightInfluence = 0
            b.MaxDistance = 10000
            b.Parent = character
            table.insert(ESP.items, b)

            local label = Instance.new("TextLabel")
            label.Size = UDim2.new(1, 0, 1, 0)
            label.BackgroundTransparency = 1
            label.Text = player.Name
            label.TextColor3 = Color3.new(1, 1, 1)
            label.TextStrokeColor3 = Color3.new(0, 0, 0)
            label.TextStrokeTransparency = 0.2
            label.TextSize = 15
            label.Font = Enum.Font.SourceSansBold
            label.Parent = b
        elseif distance >= 300 and existing then
            existing:Destroy()
        end
    end

    local function applyESP(player)
        if player == localPlayer then return end
        if player.Character then applyESPToCharacter(player, player.Character) end
        table.insert(ESP.connections, player.CharacterAdded:Connect(function(char)
            task.wait(0.2)
            applyESPToCharacter(player, char)
        end))
    end

    for _, p in ipairs(Players:GetPlayers()) do
        applyESP(p)
    end

    table.insert(ESP.connections, Players.PlayerAdded:Connect(applyESP))

    table.insert(ESP.connections, Players.PlayerRemoving:Connect(function(p)
        if p.Character then
            local h = p.Character:FindFirstChild("ESP_Highlight")
            if h then h:Destroy() end
            local b = p.Character:FindFirstChild("ESP_NameTag")
            if b then b:Destroy() end
        end
    end))

    -- ✅ Bucle optimizado sin task.wait
    local lastUpdate = 0
    ESP.loop = RunService.Heartbeat:Connect(function()
        if os.clock() - lastUpdate >= 1 then
            lastUpdate = os.clock()
            for _, p in ipairs(Players:GetPlayers()) do
                if p ~= localPlayer and p.Character then
                    applyESPToCharacter(p, p.Character)
                end
            end
        end
    end)

    print("✅ ESP activado con borde gris y nombres visibles")
end
