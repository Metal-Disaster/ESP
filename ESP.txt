return function(state)
    local Players = game:GetService("Players")
    local RunService = game:GetService("RunService")
    local localPlayer = Players.LocalPlayer

    if not getgenv().ESP_DATA then
        getgenv().ESP_DATA = {
            loop = nil,
            items = {},
            connections = {}
        }
    end

    local ESP = getgenv().ESP_DATA

    local function clearESP()
        if ESP.loop then
            ESP.loop:Disconnect()
            ESP.loop = nil
        end

        for _, obj in ipairs(ESP.items) do
            if obj and obj.Parent then obj:Destroy() end
        end
        ESP.items = {}

        for _, conn in ipairs(ESP.connections) do
            pcall(function() conn:Disconnect() end)
        end
        ESP.connections = {}
    end

    if not state then
        clearESP()
        print("❌ ESP desactivado")
        return
    end

    local function applyHighlightOnly(player, character)
        if not character or player == localPlayer then return end
        if character:FindFirstChild("ESP_Highlight") then return end

        local highlight = Instance.new("Highlight")
        highlight.Name = "ESP_Highlight"
        highlight.Adornee = character
        highlight.FillColor = Color3.fromRGB(255, 255, 255)
        highlight.FillTransparency = 1 -- sin relleno (solo borde)
        highlight.OutlineColor = Color3.fromRGB(255, 255, 255)
        highlight.OutlineTransparency = 0 -- borde visible
        highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop -- se ve incluso detrás de objetos
        highlight.Parent = character
        table.insert(ESP.items, highlight)
    end

    local function handlePlayer(player)
        if player == localPlayer then return end
        if player.Character then applyHighlightOnly(player, player.Character) end

        table.insert(ESP.connections, player.CharacterAdded:Connect(function(char)
            task.wait(0.2)
            applyHighlightOnly(player, char)
        end))
    end

    for _, p in ipairs(Players:GetPlayers()) do
        handlePlayer(p)
    end

    table.insert(ESP.connections, Players.PlayerAdded:Connect(handlePlayer))

    table.insert(ESP.connections, Players.PlayerRemoving:Connect(function(p)
        if p.Character then
            local h = p.Character:FindFirstChild("ESP_Highlight")
            if h then h:Destroy() end
        end
    end))

    -- 🔁 Bucle de actualización sin task.wait
    local lastUpdate = 0
    ESP.loop = RunService.Heartbeat:Connect(function()
        if os.clock() - lastUpdate >= 1 then
            lastUpdate = os.clock()
            for _, p in ipairs(Players:GetPlayers()) do
                if p ~= localPlayer and p.Character then
                    applyHighlightOnly(p, p.Character)
                end
            end
        end
    end)

    print("✅ ESP activado: sin nombres, solo borde blanco limpio")
end
